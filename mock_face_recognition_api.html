<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模拟人脸识别API文档</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        h2 {
            color: #007bff;
            margin-top: 30px;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin: 20px 0;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
            margin: 20px 0;
        }
        .api-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .api-title {
            color: #007bff;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            margin-right: 10px;
        }
        .post { background-color: #28a745; }
        .get { background-color: #007bff; }
        .delete { background-color: #dc3545; }
        .endpoint {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .description {
            color: #666;
            margin: 10px 0;
        }
        .code-block {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .response-example {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
        }
        .highlight {
            background-color: #ffeb3b;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .feature-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .feature-item h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        .mock-badge {
            background-color: #6c757d;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎭 模拟人脸识别API文档 <span class="mock-badge">仅供演示</span></h1>
        
        <div class="warning">
            <strong>⚠️ 重要提醒：</strong>
            <p>这是一个纯模拟的人脸识别API系统，设计用于演示和测试目的。</p>
            <ul>
                <li>所有上传的图片仅存储在服务器内存中，不会保存到数据库或硬盘</li>
                <li>人脸质量检测结果是随机生成的，不是真实的人脸识别算法</li>
                <li>重启服务器后所有模拟数据将会丢失</li>
                <li>此功能仅用于展示家长绑定孩子时的完整流程</li>
            </ul>
        </div>
        
        <div class="info">
            <strong>💡 使用场景：</strong>
            家长在绑定孩子账号时，系统要求上传几张孩子的清晰照片作为人脸识别训练数据。
            系统会模拟检测照片质量，如果上传的照片数量不足或质量不佳，会提示家长重新上传。
        </div>

        <h2>🔧 核心功能</h2>
        <div class="feature-list">
            <div class="feature-item">
                <h4>📁 内存存储</h4>
                <p>使用multer的memoryStorage，照片仅存储在内存中，不写入硬盘文件系统</p>
            </div>
            <div class="feature-item">
                <h4>🎯 质量检测</h4>
                <p>模拟人脸质量检测，随机生成质量分数和4级评分（优秀/良好/一般/较差）</p>
            </div>
            <div class="feature-item">
                <h4>📊 实时反馈</h4>
                <p>上传后立即返回检测结果，包含建议和下一步操作指引</p>
            </div>
            <div class="feature-item">
                <h4>🗂️ 状态管理</h4>
                <p>在内存中维护每个孩子的训练状态，包括已上传照片数量和质量统计</p>
            </div>
        </div>

        <h2>🔌 API接口</h2>
        
        <div class="api-section">
            <div class="api-title">
                <span class="method post">POST</span>
                上传人脸识别训练数据（模拟）
            </div>
            <div class="endpoint">/api/mock-face-recognition/upload-training-data</div>
            <div class="description">
                家长为已绑定的孩子上传人脸识别训练照片，系统会模拟检测人脸质量并给出评分。
            </div>
            
            <h4>请求参数：</h4>
            <div class="code-block">
Content-Type: multipart/form-data
Authorization: Bearer &lt;parent_token&gt;

FormData:
- childId: 孩子的ID (必填)
- faceImages: 照片文件数组 (必填，最多10张)
            </div>
            
            <h4>响应示例：</h4>
            <div class="response-example">
                <pre>{
  "message": "人脸识别训练数据上传完成（模拟）",
  "childInfo": {
    "id": 1,
    "name": "小明",
    "student_number": "2024001",
    "class_name": "大班一班"
  },
  "results": [
    {
      "filename": "child1.jpg",
      "status": "success",
      "faceDetected": true,
      "qualityScore": 0.85,
      "faceQuality": "excellent",
      "needsReview": false,
      "fileSize": 1024000,
      "processTime": "2024-01-15T10:30:00Z"
    }
  ],
  "summary": {
    "totalUploaded": 1,
    "successCount": 1,
    "qualityIssueCount": 0,
    "recommendation": {
      "status": "nearly_sufficient",
      "message": "还需要上传 4 张高质量照片",
      "action": "upload_more"
    }
  },
  "mockNote": "这是模拟功能，数据未真正存储到数据库"
}</pre>
            </div>
        </div>

        <div class="api-section">
            <div class="api-title">
                <span class="method get">GET</span>
                获取孩子的人脸训练数据状态（模拟）
            </div>
            <div class="endpoint">/api/mock-face-recognition/training-status/:childId</div>
            <div class="description">
                查看指定孩子的人脸识别训练数据状态，包括已上传照片数量、质量评分等。
            </div>
            
            <h4>请求参数：</h4>
            <div class="code-block">
Authorization: Bearer &lt;parent_token&gt;
URL参数: childId (孩子的ID)
            </div>
            
            <h4>响应示例：</h4>
            <div class="response-example">
                <pre>{
  "childId": 1,
  "childInfo": {
    "id": 1,
    "name": "小明",
    "student_number": "2024001",
    "class_name": "大班一班"
  },
  "totalImages": 3,
  "approvedImages": 2,
  "averageQuality": 0.78,
  "goodQualityImages": 2,
  "trainingCompleted": false,
  "images": [
    {
      "id": 1641369825000,
      "image_name": "child1.jpg",
      "quality_score": 0.85,
      "face_detected": true,
      "face_quality": "excellent",
      "status": "approved",
      "upload_time": "2024-01-15T10:30:00Z"
    }
  ],
  "requirements": {
    "minImages": 5,
    "minQuality": 0.6,
    "currentStatus": "incomplete"
  },
  "mockNote": "这是模拟数据，未真正存储到数据库"
}</pre>
            </div>
        </div>

        <div class="api-section">
            <div class="api-title">
                <span class="method delete">DELETE</span>
                删除人脸训练数据（模拟）
            </div>
            <div class="endpoint">/api/mock-face-recognition/training-data/:imageId</div>
            <div class="description">
                删除指定的人脸训练照片，如果质量不佳可以删除重新上传。
            </div>
            
            <h4>请求参数：</h4>
            <div class="code-block">
Authorization: Bearer &lt;parent_token&gt;
URL参数: imageId (照片的ID或文件名)
            </div>
            
            <h4>响应示例：</h4>
            <div class="response-example">
                <pre>{
  "message": "训练数据删除成功（模拟）",
  "mockNote": "这是模拟操作，未真正删除数据库中的数据"
}</pre>
            </div>
        </div>

        <div class="api-section">
            <div class="api-title">
                <span class="method post">POST</span>
                清空所有模拟数据（开发测试用）
            </div>
            <div class="endpoint">/api/mock-face-recognition/clear-mock-data</div>
            <div class="description">
                清空内存中的所有模拟数据，用于开发测试。
            </div>
            
            <h4>响应示例：</h4>
            <div class="response-example">
                <pre>{
  "message": "所有模拟数据已清空",
  "mockNote": "这仅清空内存中的模拟数据"
}</pre>
            </div>
        </div>

        <h2>🤖 模拟人脸质量检测函数</h2>
        <div class="api-section">
            <div class="api-title">simulateFaceQualityCheck(imageBuffer, originalName)</div>
            <div class="description">
                这是核心的模拟函数，用于模拟真实的人脸质量检测过程。
            </div>
            
            <h4>检测功能：</h4>
            <ul>
                <li><strong>人脸检测:</strong> 90%概率检测到人脸（随机模拟）</li>
                <li><strong>质量评分:</strong> 0.3-1.0分，4级评分系统</li>
                <li><strong>处理延迟:</strong> 1-3秒随机延迟，模拟真实处理时间</li>
                <li><strong>特征提取:</strong> 模拟128维人脸特征向量</li>
                <li><strong>关键点检测:</strong> 模拟眼部、鼻子、嘴部坐标</li>
                <li><strong>人脸定位:</strong> 模拟人脸边界框坐标</li>
            </ul>
            
            <h4>质量等级：</h4>
            <div class="code-block">
excellent (优秀): 质量分 >= 0.8
good (良好):     质量分 >= 0.6
fair (一般):     质量分 >= 0.4
poor (较差):     质量分 < 0.4
            </div>
        </div>

        <h2>📋 使用流程</h2>
        <div class="api-section">
            <ol>
                <li><strong>家长绑定孩子:</strong> 通过学号绑定孩子账号</li>
                <li><strong>触发上传界面:</strong> 绑定成功后自动显示人脸数据上传界面</li>
                <li><strong>选择照片:</strong> 家长选择孩子的清晰照片（支持拖拽上传）</li>
                <li><strong>质量检测:</strong> 系统模拟检测每张照片的人脸质量</li>
                <li><strong>查看结果:</strong> 显示检测结果和质量评分</li>
                <li><strong>重新上传:</strong> 如果质量不佳，家长可以删除重新上传</li>
                <li><strong>完成训练:</strong> 至少需要5张高质量照片才能完成训练</li>
            </ol>
        </div>

        <h2>🎯 智能建议系统</h2>
        <div class="api-section">
            <div class="api-title">getUploadRecommendation(successCount, qualityIssueCount)</div>
            <div class="description">
                根据已上传照片的数量和质量，提供智能建议和下一步操作指引。
            </div>
            
            <h4>建议类型：</h4>
            <div class="feature-list">
                <div class="feature-item">
                    <h4>🎉 sufficient (充足)</h4>
                    <p>已有5张以上高质量照片，可以完成训练</p>
                </div>
                <div class="feature-item">
                    <h4>⚠️ nearly_sufficient (接近充足)</h4>
                    <p>已有3-4张高质量照片，还需上传更多</p>
                </div>
                <div class="feature-item">
                    <h4>📸 insufficient (不足)</h4>
                    <p>高质量照片不足3张，提供详细上传建议</p>
                </div>
            </div>
        </div>

        <h2>🔧 技术实现</h2>
        <div class="api-section">
            <h4>内存存储：</h4>
            <div class="code-block">
// 使用Map存储模拟数据
const mockTrainingData = new Map(); // childId -> training data

// 配置内存存储
const storage = multer.memoryStorage();
            </div>
            
            <h4>文件验证：</h4>
            <div class="code-block">
fileFilter: function (req, file, cb) {
  const allowedTypes = ['image/jpg','image/jpeg','image/png','image/bmp','image/tiff','image/webp'];
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('只支持 JPG、JPEG\PNG、BMP、TIFF、WEBP 格式的图片'), false);
  }
}
            </div>
        </div>

        <h2>📝 注意事项</h2>
        <div class="warning">
            <ul>
                <li>这是纯模拟功能，不涉及真实的人脸识别算法</li>
                <li>上传的照片不会保存到硬盘，仅存储在服务器内存中</li>
                <li>重启服务器后所有模拟数据将会丢失</li>
                <li>质量检测结果是随机生成的，不代表真实的照片质量</li>
                <li>此功能主要用于演示完整的用户交互流程</li>
                <li>在生产环境中，应该使用真实的人脸识别服务</li>
            </ul>
        </div>

        <h2>🚀 如何测试</h2>
        <div class="info">
            <ol>
                <li>启动后端服务器</li>
                <li>使用家长账号登录前端系统</li>
                <li>进入"绑定孩子"页面</li>
                <li>输入学号绑定孩子</li>
                <li>绑定成功后会自动显示人脸数据上传界面</li>
                <li>选择几张照片进行上传测试</li>
                <li>观察模拟的质量检测结果和建议</li>
            </ol>
        </div>
    </div>
</body>
</html> 