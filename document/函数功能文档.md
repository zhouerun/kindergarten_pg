# 幼儿园管理系统 - 函数功能文档

## 目录
1. [认证相关函数](#认证相关函数)
2. [用户管理函数](#用户管理函数)
3. [班级管理函数](#班级管理函数)
4. [照片管理函数](#照片管理函数)
5. [人脸识别函数](#人脸识别函数)
6. [数据库操作函数](#数据库操作函数)
7. [中间件函数](#中间件函数)
8. [工具函数](#工具函数)
9. [前端组件函数](#前端组件函数)

---

## 认证相关函数

### 1. 用户登录函数
**文件**: `backend/routes/auth.js`
**函数**: `POST /auth/login`

**功能**: 验证用户凭据并生成访问令牌

**输入参数**:
```javascript
{
  username: string,  // 用户名
  password: string   // 密码（至少6位）
}
```

**输出结果**:
```javascript
{
  message: "登录成功",
  accessToken: string,    // JWT访问令牌
  refreshToken: string,   // JWT刷新令牌
  user: {
    id: number,
    username: string,
    role: "teacher" | "parent",
    full_name: string,
    class_id: number
  }
}
```

**主要逻辑**:
1. 验证输入参数
2. 查询数据库验证用户凭据
3. 使用bcrypt验证密码哈希
4. 生成访问令牌和刷新令牌
5. 返回用户信息和令牌

### 2. 用户注册函数
**文件**: `backend/routes/auth.js`
**函数**: `POST /auth/register`

**功能**: 创建新用户账户

**输入参数**:
```javascript
{
  username: string,           // 用户名（至少3位）
  password: string,           // 密码（至少6位）
  role: "teacher" | "parent", // 角色
  full_name: string,          // 姓名
  telephone_number: string,   // 手机号码
  class_id?: number          // 班级ID（可选）
}
```

**输出结果**:
```javascript
{
  message: "注册成功",
  user: {
    id: number,
    username: string,
    role: string,
    full_name: string,
    telephone_number: string,
    class_id: number | null
  }
}
```

**主要逻辑**:
1. 验证输入参数
2. 检查用户名和电话号码是否已存在
3. 使用bcrypt加密密码
4. 创建用户记录
5. 返回用户信息

### 3. 修改密码函数
**文件**: `backend/routes/auth.js`
**函数**: `POST /auth/change-password`

**功能**: 修改当前用户的密码

**输入参数**:
```javascript
{
  currentPassword: string,  // 当前密码
  newPassword: string      // 新密码（至少6位）
}
```

**输出结果**:
```javascript
{
  message: "密码修改成功"
}
```

**主要逻辑**:
1. 验证当前密码
2. 加密新密码
3. 更新数据库中的密码

### 4. 刷新令牌函数
**文件**: `backend/routes/auth.js`
**函数**: `POST /auth/refresh`

**功能**: 使用刷新令牌获取新的访问令牌

**输入参数**:
```javascript
{
  refreshToken: string  // 刷新令牌
}
```

**输出结果**:
```javascript
{
  message: "令牌刷新成功",
  accessToken: string,
  user: {
    id: number,
    username: string,
    role: string,
    full_name: string,
    class_id: number
  }
}
```

**主要逻辑**:
1. 验证刷新令牌
2. 从数据库获取用户信息
3. 生成新的访问令牌
4. 返回用户信息和令牌

**前端自动刷新机制**:
- 当API请求返回401错误时，前端会自动尝试使用refreshToken刷新访问令牌
- 刷新成功后会自动重试原请求，用户无感知
- 刷新失败才会跳转到登录页面
- 实现文件：`frontend/src/utils/axios.js`

**防重复刷新机制**:
- 使用 `isRefreshing` 标志防止多个请求同时触发刷新
- 使用 `failedQueue` 队列管理刷新期间的失败请求
- 刷新成功后自动重试队列中的所有请求
- 刷新失败时拒绝队列中的所有请求并跳转登录

**刷新流程**:
1. 检测到401错误
2. 检查是否有refreshToken
3. 如果没有refreshToken，直接跳转登录
4. 如果有refreshToken，检查是否正在刷新
5. 如果正在刷新，将请求加入队列等待
6. 如果未在刷新，开始刷新流程
7. 刷新成功后更新token并重试原请求
8. 刷新失败则清除认证信息并跳转登录

---

## 用户管理函数

### 1. 获取用户信息函数
**文件**: `backend/routes/users.js`
**函数**: `GET /users/profile`

**功能**: 获取当前用户的详细信息

**输入参数**: 无（从JWT token获取用户ID）

**输出结果**:
```javascript
{
  id: number,
  username: string,
  role: string,
  full_name: string,
  class_id: number,
  created_at: string,
  children?: Array,    // 家长用户的孩子信息
  class?: Object       // 教师用户的班级信息
}
```

**主要逻辑**:
1. 从JWT token获取用户ID
2. 查询用户基本信息
3. 根据角色获取关联信息（孩子/班级）
4. 返回完整用户信息

### 2. 更新用户信息函数
**文件**: `backend/routes/users.js`
**函数**: `PUT /users/profile`

**功能**: 更新当前用户的基本信息

**输入参数**:
```javascript
{
  full_name: string  // 姓名
}
```

**输出结果**:
```javascript
{
  message: "用户信息更新成功"
}
```

**主要逻辑**:
1. 验证输入参数
2. 更新数据库中的用户信息
3. 返回成功消息

### 3. 获取用户列表函数
**文件**: `backend/routes/users.js`
**函数**: `GET /users`

**功能**: 获取所有用户列表（仅教师可用）

**输入参数**:
- `role`: 可选查询参数，筛选特定角色

**输出结果**:
```javascript
[
  {
    id: number,
    username: string,
    role: string,
    full_name: string,
    class_id: number,
    created_at: string,
    class_name: string,
    children?: Array  // 家长用户的孩子信息
  }
]
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 根据查询参数筛选用户
3. 为家长用户获取孩子信息
4. 返回用户列表

### 4. 获取家长列表函数
**文件**: `backend/routes/users.js`
**函数**: `GET /users/parents`

**功能**: 获取所有家长用户列表（仅教师可用）

**输入参数**: 无

**输出结果**:
```javascript
[
  {
    id: number,
    username: string,
    full_name: string,
    class_id: number,
    created_at: string,
    class_name: string,
    children: Array  // 关联的孩子信息
  }
]
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 查询所有家长用户
3. 为每个家长获取孩子信息
4. 返回家长列表

### 5. 获取孩子列表函数
**文件**: `backend/routes/users.js`
**函数**: `GET /users/children`

**功能**: 获取当前家长关联的孩子列表（家长专用）

**输入参数**: 无（从JWT token获取家长ID）

**输出结果**:
```javascript
[
  {
    id: number,
    name: string,
    age: number,
    class_id: number,
    created_at: string,
    class_name: string
  }
]
```

**主要逻辑**:
1. 验证用户权限（仅家长）
2. 查询家长关联的孩子
3. 返回孩子列表

### 6. 绑定孩子函数
**文件**: `backend/routes/users.js`
**函数**: `POST /users/bind-child`

**功能**: 家长通过学号绑定孩子（家长专用）

**输入参数**:
```javascript
{
  studentNumber: string  // 学号
}
```

**输出结果**:
```javascript
{
  message: "绑定成功",
  child: {
    id: number,
    name: string,
    student_number: string,
    age: number
  }
}
```

**主要逻辑**:
1. 验证用户权限（仅家长）
2. 根据学号查找孩子
3. 检查是否已绑定
4. 创建绑定关系
5. 返回孩子信息

### 7. 解绑孩子函数
**文件**: `backend/routes/users.js`
**函数**: `DELETE /users/bind-child`

**功能**: 家长解绑孩子（家长专用）

**输入参数**:
```javascript
{
  childId: number  // 孩子ID
}
```

**输出结果**:
```javascript
{
  message: "解绑成功"
}
```

**主要逻辑**:
1. 验证用户权限（仅家长）
2. 检查绑定关系是否存在
3. 删除绑定关系
4. 返回成功消息

---

## 班级管理函数

（标注：后面可能是从主的用户表里面调信息）
### 1. 获取班级列表函数
**文件**: `backend/routes/classes.js`
**函数**: `GET /classes`

**功能**: 获取所有班级信息

**输入参数**: 无

**输出结果**:
```javascript
[
  {
    id: number,
    name: string,
    created_at: string,
    teacher_name: string,
    student_count: number
  }
]
```

**主要逻辑**:
1. 查询所有班级信息
2. 关联教师信息
3. 统计学生数量
4. 返回班级列表

（标注：后面可能是从主的用户表里面调信息）
### 2. 获取学生列表函数
**文件**: `backend/routes/classes.js`
**函数**: `GET /classes/students`

**功能**: 获取所有学生信息

**输入参数**: 无

**输出结果**:
```javascript
[
  {
    id: number,
    name: string,
    student_number: string,
    age: number,
    class_id: number,
    created_at: string,
    class_name: string
  }
]
```

**主要逻辑**:
1. 查询所有学生信息
2. 关联班级信息
3. 按班级和学生姓名排序
4. 返回学生列表

（标注：后面可能是从主的用户表里面调信息，所以可能没有这一步了）
### 3. 添加学生函数
**文件**: `backend/routes/classes.js`
**函数**: `POST /classes/students`

**功能**: 添加新学生（仅教师可用）

**输入参数**:
```javascript
{
  name: string,           // 学生姓名
  student_number: string, // 学号
  age: number,            // 年龄
  class_id: number        // 班级ID
}
```

**输出结果**:
```javascript
{
  message: "学生添加成功",
  child: {
    id: number,
    name: string,
    student_number: string,
    age: number,
    class_id: number
  }
}
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 验证输入参数
3. 检查班级是否存在
4. 检查学号是否重复
5. 创建学生记录
6. 返回学生信息

（标注：后面可能是从主的用户表里面调信息，所以可能应用这边改不了学生信息 ）
### 4. 更新学生信息函数
**文件**: `backend/routes/classes.js`
**函数**: `PUT /classes/students/{id}`

**功能**: 更新学生信息（仅教师可用）

**输入参数**:
```javascript
{
  name: string,           // 学生姓名
  student_number: string, // 学号
  age: number,            // 年龄
  class_id: number        // 班级ID
}
```

**输出结果**:
```javascript
{
  message: "学生信息更新成功"
}
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 验证输入参数
3. 检查学生是否存在
4. 检查学号是否重复（排除当前学生）
5. 更新学生信息
6. 返回成功消息

（标注：后面可能是从主的用户表里面调信息，所以应该没有这一步了）
### 5. 删除学生函数
**文件**: `backend/routes/classes.js`
**函数**: `DELETE /classes/students/{id}`

**功能**: 删除学生（仅教师可用）

**输入参数**: 无（从URL参数获取学生ID）

**输出结果**:
```javascript
{
  message: "学生删除成功"
}
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 检查学生是否存在
3. 删除学生记录
4. 返回成功消息

（标注：后面可能是从主的用户表里面调信息）
### 6. 获取班级详情函数
**文件**: `backend/routes/classes.js`
**函数**: `GET /classes/{id}`

**功能**: 获取指定班级的详细信息

**输入参数**: 无（从URL参数获取班级ID）

**输出结果**:
```javascript
{
  id: number,
  name: string,
  created_at: string,
  teacher_name: string,
  teacher_id: number,
  students: Array,      // 班级学生列表
  photo_count: number   // 班级照片数量
}
```

**主要逻辑**:
1. 查询班级基本信息
2. 获取班级学生列表
3. 统计班级照片数量
4. 返回班级详情

（标注：后面可能是从主的用户表里面调信息）
### 7. 获取班级学生函数
**文件**: `backend/routes/classes.js`
**函数**: `GET /classes/{id}/children`

**功能**: 获取指定班级的学生列表

**输入参数**: 无（从URL参数获取班级ID）

**输出结果**:
```javascript
[
  {
    id: number,
    name: string,
    student_number: string,
    created_at: string
  }
]
```

**主要逻辑**:
1. 验证用户权限（教师只能查看自己班级）
2. 查询班级学生列表
3. 返回学生列表

（标注：后面可能是从主的用户表里面调信息，可能不需要这一步）
### 8. 创建班级函数
**文件**: `backend/routes/classes.js`
**函数**: `POST /classes`

**功能**: 创建新班级（仅教师可用）

**输入参数**:
```javascript
{
  name: string  // 班级名称
}
```

**输出结果**:
```javascript
{
  message: "班级创建成功",
  class: {
    id: number,
    name: string,
    teacher_id: number
  }
}
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 验证输入参数
3. 检查班级名称是否重复
4. 创建班级记录
5. 返回班级信息

（标注：后面可能是从主的用户表里面调信息，可能不需要这一步）
### 9. 添加学生到班级函数
**文件**: `backend/routes/classes.js`
**函数**: `POST /classes/{id}/children`

**功能**: 向指定班级添加学生（仅教师可用）

**输入参数**:
```javascript
{
  name: string,           // 学生姓名
  student_number: string  // 学号
}
```

**输出结果**:
```javascript
{
  message: "学生添加成功",
  child: {
    id: number,
    name: string,
    student_number: string,
    class_id: number
  }
}
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 验证输入参数
3. 检查班级权限
4. 检查学号是否重复
5. 创建学生记录
6. 返回学生信息

（标注：后面可能是从主的用户表里面调信息，可能不需要这一步）
### 10. 删除班级学生函数
**文件**: `backend/routes/classes.js`
**函数**: `DELETE /classes/{id}/children/{childId}`

**功能**: 从指定班级删除学生（仅教师可用）

**输入参数**: 无（从URL参数获取班级ID和学生ID）

**输出结果**:
```javascript
{
  message: "学生删除成功"
}
```

**主要逻辑**:
1. 验证用户权限（仅教师）
2. 检查班级权限
3. 检查学生是否存在
4. 删除学生记录
5. 返回成功消息

---

## 照片管理函数

（标注：前端还没改成分页）
### 1. 获取公共照片墙函数
**文件**: `backend/routes/photos.js`
**函数**: `GET /photos/public`

**功能**: 获取公共照片墙，支持分页

**输入参数**:
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）

**输出结果**:
```javascript
{
  photos: [
    {
      id: number,
      path: string,
      created_at: string,
      activity: string,
      uploader_name: string,
      class_name: string,
      recognition_data: string,
      like_count: number,
      children: Array  // 识别到的孩子信息
    }
  ],
  pagination: {
    page: number,
    limit: number,
    total: number
  }
}
```

**主要逻辑**:
1. 验证分页参数
2. 查询公共照片
3. 获取照片点赞数
4. 获取识别到的孩子信息
5. 计算分页信息
6. 返回照片列表和分页信息

### 2. 照片点赞函数
**文件**: `backend/routes/photos.js`
**函数**: `POST /photos/like`

**功能**: 对照片进行点赞或取消点赞

**输入参数**:
```javascript
{
  photoId: number  // 照片ID
}
```

**输出结果**:
```javascript
{
  message: string,  // "点赞成功" 或 "取消点赞成功"
  liked: boolean    // 当前点赞状态
}
```

**主要逻辑**:
1. 检查是否已点赞
2. 如果已点赞则取消，否则添加点赞
3. 返回操作结果和当前状态

### 3. 获取照片集函数（家长专用）
**文件**: `backend/routes/photos.js`
**函数**: `GET /photos/albums`

**功能**: 获取家长孩子的照片集，按时间分组

**输入参数**:
- `groupBy`: 分组方式（day/week/month，默认month）

**输出结果**:
```javascript
{
  albums: [
    {
      child: {
        id: number,
        name: string,
        class_name: string
      },
      totalPhotos: number,
      timeGroups: [
        {
          period: string,
          formattedPeriod: string,
          photoCount: number,
          photos: Array
        }
      ]
    }
  ],
  groupBy: string
}
```

**主要逻辑**:
1. 获取家长的孩子信息
2. 获取每个孩子的照片
3. 按时间分组照片
4. 格式化时间段显示
5. 返回照片集

### 4. 获取教师照片集函数（教师专用）
**文件**: `backend/routes/photos.js`
**函数**: `GET /photos/teacher-albums`

**功能**: 获取教师管理的所有班级照片集

**输入参数**:
- `groupBy`: 分组方式（day/week/month，默认month）

**输出结果**:
```javascript
{
  albums: [
    {
      class: {
        id: number,
        name: string,
        student_count: number
      },
      totalPhotos: number,
      timeGroups: [
        {
          period: string,
          formattedPeriod: string,
          photoCount: number,
          photos: Array
        }
      ]
    }
  ],
  groupBy: string
}
```

**主要逻辑**:
1. 获取所有班级信息
2. 获取每个班级的照片
3. 按时间分组照片
4. 获取识别到的孩子信息
5. 返回照片集

### 5. 获取公共照片集函数（家长专用）
**文件**: `backend/routes/photos.js`
**函数**: `GET /photos/public-albums`

**功能**: 获取按班级和活动场景分组的公共照片集

**输入参数**:
- `groupBy`: 分组方式（day/week/month，默认month）

**输出结果**:
```javascript
{
  albums: [
    {
      class: {
        id: number,
        name: string,
        student_count: number,
        isParentClass: boolean
      },
      totalPhotos: number,
      activityGroups: [
        {
          activity: string,
          totalPhotos: number,
          timeGroups: Array
        }
      ]
    }
  ],
  groupBy: string
}
```

**主要逻辑**:
1. 获取家长的孩子信息
2. 获取所有班级的公共照片
3. 按活动场景分组
4. 再按时间分组
5. 标记家长孩子所在的班级
6. 返回照片集

### 6. 格式化时间段函数
**文件**: `backend/routes/photos.js`
**函数**: `formatPeriod(period, groupBy)`

**功能**: 格式化时间段显示

**输入参数**:
- `period`: 时间段字符串
- `groupBy`: 分组方式

**输出结果**: 格式化后的时间段字符串

**主要逻辑**:
1. 根据分组方式格式化时间段
2. 返回中文格式的时间显示

---

## 人脸识别函数

### 1. 构建远端训练数据函数
**文件**: `backend/routes/faceRecognition.js`
**函数**: `buildRemoteTrainingData(childInfo, files)`

**功能**: 构建发送给远端人脸识别服务的数据

**输入参数**:
- `childInfo`: 孩子信息对象
- `files`: 图片文件数组

**输出结果**:
```javascript
{
  name: string,
  images: Array,  // base64格式的图片数组
  profile: {
    age: number,
    student_id: number,
    class_id: number
  }
}
```

**主要逻辑**:
1. 将图片文件转换为base64格式
2. 构建符合远端API格式的数据结构
3. 返回训练数据

### 2. 发送到远端训练服务函数
**文件**: `backend/routes/faceRecognition.js`
**函数**: `sendToRemoteTrainingService(jsonData)`

**功能**: 发送训练数据到远端人脸识别服务

**输入参数**:
- `jsonData`: 训练数据对象

**输出结果**: 远端服务的响应数据

**主要逻辑**:
1. 配置HTTP请求参数
2. 发送POST请求到远端服务
3. 处理响应和错误
4. 返回响应数据

### 3. 带重试的远端服务调用函数
**文件**: `backend/routes/faceRecognition.js`
**函数**: `sendWithRetry(jsonData, maxRetries)`

**功能**: 带重试机制的远端服务调用

**输入参数**:
- `jsonData`: 要发送的数据
- `maxRetries`: 最大重试次数（默认3）

**输出结果**: 远端服务的响应数据

**主要逻辑**:
1. 尝试发送请求
2. 失败时进行重试
3. 使用指数退避延迟
4. 返回最终结果

### 4. 上传训练数据函数
**文件**: `backend/routes/faceRecognition.js`
**函数**: `POST /face-recognition/database/add_child`

**功能**: 上传孩子的人脸识别训练数据

**输入参数**:
```javascript
{
  name: string,           // 孩子姓名
  images: Array,          // base64格式的图片数组
  profile: {
    age: number,          // 年龄
    student_id: number,   // 学生ID
    class_id: number      // 班级ID
  }
}
```

**输出结果**:
```javascript
{
  message: string,
  success: boolean,
  childInfo: Object,
  results: Array,
  summary: Object,
  uploadedFiles: number
}
```

**主要逻辑**:
1. 验证输入参数
2. 查找孩子信息
3. 验证base64图片数据
4. 构建远端训练数据
5. 发送到远端服务
6. 返回处理结果

### 5. 批量识别函数
**文件**: `backend/routes/faceRecognition.js`
**函数**: `POST /face-recognition/batch-recognize`

**功能**: 批量识别照片中的人脸

**输入参数**:
```javascript
{
  image: string,      // base64格式的图片
  class_id: number    // 班级ID
}
```

**输出结果**: 远端识别服务的响应数据

**主要逻辑**:
1. 检查依赖是否安装
2. 转发请求到远端服务
3. 处理响应和错误
4. 返回识别结果

### 6. 健康检查函数
**文件**: `backend/routes/faceRecognition.js`
**函数**: `GET /face-recognition/health`

**功能**: 检查人脸识别服务的健康状态

**输入参数**: 无

**输出结果**:
```javascript
{
  status: "healthy" | "unhealthy",
  dependencies: "installed" | "missing",
  remote_service: "connected" | "disconnected",
  remote_response?: Object
}
```

**主要逻辑**:
1. 检查依赖是否安装
2. 测试远端服务连接
3. 返回健康状态

---

## 数据库操作函数

### 1. 带重试的数据库查询函数
**文件**: `backend/config/database.js`
**函数**: `executeWithRetry(sql, params, maxRetries)`

**功能**: 带重试机制的数据库查询

**输入参数**:
- `sql`: SQL查询语句
- `params`: 查询参数数组
- `maxRetries`: 最大重试次数（默认3）

**输出结果**: 查询结果数组

**主要逻辑**:
1. 执行数据库查询
2. 连接错误时进行重试
3. 使用指数退避延迟
4. 返回查询结果

### 2. 测试数据库连接函数
**文件**: `backend/config/database.js`
**函数**: `testConnection()`

**功能**: 测试数据库连接状态

**输入参数**: 无

**输出结果**: 布尔值（连接成功/失败）

**主要逻辑**:
1. 执行简单查询测试连接
2. 记录连接状态
3. 返回连接结果

### 3. 启动健康检查函数
**文件**: `backend/config/database.js`
**函数**: `startHealthCheck()`

**功能**: 启动定期数据库健康检查

**输入参数**: 无

**输出结果**: 无（启动定时器）

**主要逻辑**:
1. 设置定时器
2. 定期执行健康检查
3. 记录检查结果

### 4. 获取连接池状态函数
**文件**: `backend/config/database.js`
**函数**: `getPoolStatus()`

**功能**: 获取数据库连接池状态

**输入参数**: 无

**输出结果**:
```javascript
{
  threadId: number,
  connectionLimit: number
}
```

**主要逻辑**:
1. 获取连接池配置信息
2. 返回状态对象

---

## 中间件函数

### 1. JWT认证中间件
**文件**: `backend/middleware/auth.js`
**函数**: `authenticateToken(req, res, next)`

**功能**: 验证JWT访问令牌

**输入参数**:
- `req`: Express请求对象
- `res`: Express响应对象
- `next`: Express下一个中间件函数

**输出结果**: 无（调用next()或返回错误响应）

**主要逻辑**:
1. 从请求头提取token
2. 验证JWT token
3. 检查token是否过期
4. 从数据库获取用户信息
5. 将用户信息添加到请求对象
6. 调用下一个中间件

### 2. 角色授权中间件
**文件**: `backend/middleware/auth.js`
**函数**: `authorizeRole(roles)`

**功能**: 验证用户角色权限

**输入参数**:
- `roles`: 允许的角色数组

**输出结果**: 中间件函数

**主要逻辑**:
1. 检查用户是否已认证
2. 验证用户角色是否在允许列表中
3. 允许或拒绝访问

### 3. 生成访问令牌函数
**文件**: `backend/middleware/auth.js`
**函数**: `generateToken(user)`

**功能**: 生成JWT访问令牌

**输入参数**:
- `user`: 用户信息对象

**输出结果**: JWT token字符串

**主要逻辑**:
1. 构建token载荷
2. 使用JWT_SECRET签名
3. 设置过期时间
4. 返回token

### 4. 生成刷新令牌函数
**文件**: `backend/middleware/auth.js`
**函数**: `generateRefreshToken(user)`

**功能**: 生成JWT刷新令牌

**输入参数**:
- `user`: 用户信息对象

**输出结果**: JWT刷新token字符串

**主要逻辑**:
1. 构建token载荷（包含type标识）
2. 使用JWT_SECRET签名
3. 设置较长的过期时间
4. 返回刷新token

### 5. 验证刷新令牌函数
**文件**: `backend/middleware/auth.js`
**函数**: `verifyRefreshToken(refreshToken)`

**功能**: 验证JWT刷新令牌

**输入参数**:
- `refreshToken`: 刷新令牌字符串

**输出结果**: 解码后的token载荷或抛出错误

**主要逻辑**:
1. 验证JWT token
2. 检查token类型是否为refresh
3. 返回解码结果

---

## 工具函数

### 1. 格式化时间段函数
**文件**: `backend/routes/photos.js`
**函数**: `formatPeriod(period, groupBy)`

**功能**: 将时间段格式化为中文显示

**输入参数**:
- `period`: 时间段字符串（如"2024-01"）
- `groupBy`: 分组方式（day/week/month）

**输出结果**: 格式化后的中文时间段字符串

**主要逻辑**:
1. 解析时间段字符串
2. 根据分组方式格式化
3. 返回中文格式的时间显示

### 2. 检查本地网络函数
**文件**: `backend/server.js`
**函数**: `isLocalNetwork(origin)`

**功能**: 检查请求来源是否为本地网络

**输入参数**:
- `origin`: 请求来源URL

**输出结果**: 布尔值（是否为本地网络）

**主要逻辑**:
1. 定义本地网络IP模式
2. 匹配请求来源
3. 返回匹配结果

### 3. 限流中间件
**文件**: `backend/server.js`
**函数**: `rateLimit`

**功能**: 限制API请求频率

**输入参数**: 无（中间件配置）

**输出结果**: 中间件函数

**主要逻辑**:
1. 配置时间窗口和最大请求数
2. 统计IP请求次数
3. 超过限制时返回错误

### 4. 错误处理中间件
**文件**: `backend/server.js`
**函数**: 错误处理中间件

**功能**: 统一处理应用错误

**输入参数**:
- `err`: 错误对象
- `req`: 请求对象
- `res`: 响应对象
- `next`: 下一个中间件

**输出结果**: 错误响应

**主要逻辑**:
1. 记录错误日志
2. 根据环境返回错误信息
3. 返回适当的HTTP状态码

### 5. 404处理中间件
**文件**: `backend/server.js`
**函数**: 404处理中间件

**功能**: 处理未找到的路由

**输入参数**:
- `req`: 请求对象
- `res`: 响应对象

**输出结果**: 404错误响应

**主要逻辑**:
1. 返回404状态码
2. 返回错误消息

---

## 服务器配置函数

### 1. CORS配置
**文件**: `backend/server.js`
**功能**: 配置跨域资源共享

**配置项**:
- 允许的源列表
- 本地网络访问支持
- 请求方法和头部配置

### 2. 静态文件服务
**文件**: `backend/server.js`
**功能**: 提供上传文件的静态访问

**配置项**:
- 文件目录路径
- CORS头部配置
- 文件访问权限

### 3. 路由注册
**文件**: `backend/server.js`
**功能**: 注册所有API路由

**路由模块**:
- `/api/auth`: 认证相关
- `/api/photos`: 照片管理
- `/api/classes`: 班级管理
- `/api/users`: 用户管理
- `/api/face-recognition`: 人脸识别

### 4. 健康检查端点
**文件**: `backend/server.js`
**功能**: 提供系统健康状态检查

**端点**: `GET /api/health`

**返回结果**:
```javascript
{
  status: "OK",
  timestamp: string
}
```

---
（标注：2025.8.6新加的）
## 前端组件函数

### 1. FullScreenView 全屏图片查看组件
**文件**: `frontend/src/components/FullScreenView.vue`
**组件名**: `FullScreenView`

**功能**: 提供全屏图片查看功能，支持触摸拖拽、缩放、切换等交互操作

**Props 参数**:
```javascript
{
  visible: {
    type: Boolean,
    default: false
  },
  photos: {
    type: Array,
    default: () => []
  },
  initialIndex: {
    type: Number,
    default: 0
  }
}
```

**Emits 事件**:
```javascript
{
  'close': () => void,           // 关闭全屏查看
  'update:visible': (boolean)    // 更新显示状态
}
```

**主要功能**:

#### 1.1 图片切换功能
- **拖拽切换**: 支持左右拖拽切换上一张/下一张图片
- **按钮切换**: 提供左右箭头按钮进行图片切换
- **键盘切换**: 支持左右方向键切换图片
- **边界检测**: 第一张图片无法向左切换，最后一张图片无法向右切换

#### 1.2 触摸交互功能
- **单击退出**: 单击图片区域退出全屏查看
- **拖拽识别**: 区分水平拖拽（切换图片）和垂直拖拽（退出全屏）
- **双指缩放**: 支持双指缩放图片（0.5x - 3x）
- **按钮保护**: 触摸按钮区域时不会触发拖拽操作

#### 1.3 图片操作功能
- **点赞功能**: 支持对当前图片进行点赞/取消点赞
- **错误处理**: 图片加载失败时显示默认占位图
- **响应式设计**: 适配移动端和桌面端显示

#### 1.4 界面元素
- **照片计数器**: 显示当前图片位置（如：3 / 10）
- **导航按钮**: 桌面端显示左右切换按钮
- **操作按钮**: 点赞按钮和关闭按钮
- **移动端优化**: 移动端隐藏导航按钮，优化按钮位置

**使用示例**:
```vue
<template>
  <FullScreenView
    v-model:visible="showFullscreen"
    :photos="photoList"
    :initial-index="selectedIndex"
    @close="handleClose"
  />
</template>

<script>
import FullScreenView from '@/components/FullScreenView.vue'

export default {
  components: {
    FullScreenView
  },
  data() {
    return {
      showFullscreen: false,
      photoList: [
        { id: 1, path: '/uploads/photo1.jpg', liked: false },
        { id: 2, path: '/uploads/photo2.jpg', liked: true }
      ],
      selectedIndex: 0
    }
  },
  methods: {
    handleClose() {
      this.showFullscreen = false
    }
  }
}
</script>
```

**技术特点**:
1. **Vue 3 Composition API**: 使用 `ref`、`computed`、`watch` 等响应式API
2. **触摸事件处理**: 完整的 `touchstart`、`touchmove`、`touchend` 事件处理
3. **CSS 变换**: 使用 `transform` 实现图片拖拽和缩放效果
4. **防抖优化**: 窗口大小变化时使用防抖函数优化性能
5. **键盘事件**: 支持键盘快捷键操作
6. **响应式设计**: 根据屏幕尺寸调整界面布局

**交互说明**:
- **单击**: 退出全屏查看
- **左右拖拽**: 切换上一张/下一张图片（需拖拽距离≥100px）
- **上下拖拽**: 退出全屏查看（需拖拽距离≥100px）
- **双指缩放**: 放大/缩小图片
- **左右方向键**: 切换图片
- **ESC键**: 退出全屏查看

---

## 总结

这个函数功能文档详细介绍了幼儿园管理系统中所有主要函数的功能、输入输出参数和处理逻辑。主要包括：

1. **认证相关函数**: 处理用户登录、注册、密码修改等
2. **用户管理函数**: 管理用户信息、家长孩子绑定等
3. **班级管理函数**: 管理班级和学生信息
4. **照片管理函数**: 处理照片上传、查看、分组等
5. **人脸识别函数**: 处理人脸识别训练和识别
6. **数据库操作函数**: 提供数据库连接和查询功能
7. **中间件函数**: 处理认证、授权等中间件逻辑
8. **工具函数**: 提供各种辅助功能
9. **前端组件函数**: 提供用户界面交互组件

每个函数都包含了详细的输入输出说明和处理逻辑，便于开发人员理解和维护代码。 