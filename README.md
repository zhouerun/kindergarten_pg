# 幼儿园照片管理系统

## 最新更新 (2025年7月9日)

### 新增功能：
1. **照片活动场景标记**：教师上传照片时可以选择活动场景，便于照片分类和管理
   - 支持14种预设场景：户外活动、室内游戏、美术手工、音乐舞蹈、体育运动、科学实验、阅读时间、午餐时间、午休时间、集体活动、自由活动、节日庆祝、生日聚会、其他
   - 活动场景信息存储在数据库中，可用于后续的照片筛选和分类
   - 前端界面新增活动场景选择下拉框，用户体验友好
   - 家长端可以查看照片的活动场景信息，了解孩子参与的活动类型

### 已修复的问题：
1. **Element UI ElOption null值问题**：修复了PublicPhotos.vue中ElOption组件不接受null值的问题，改为使用空字符串''
2. **500错误问题**：添加了详细的错误处理和日志记录，临时使用模拟数据解决API调用失败问题
3. **数据库连接问题**：创建了数据库初始化脚本，并添加了完整的错误处理机制
4. **前端ElSelect组件优化**：修复了所有与null值相关的类型检查错误

### 技术改进：
- 添加了详细的日志记录用于调试
- 优化了错误处理机制
- 创建了数据库初始化脚本
- 增强了API的健壮性
- 数据库schema更新：photos表增加activity字段，photo_child表建立照片与儿童的关联
- 人脸识别关联优化：上传照片后自动将识别到的孩子ID插入photo_child关联表
- 家长端查询优化：使用parent_child和photo_child表进行精确的关联查询

### 使用说明：
1. 确保MySQL服务正在运行
2. 复制`backend/config/env.template`为`backend/.env`并配置数据库连接
3. 运行`node backend/init_db.js`初始化数据库
4. 使用`start.cmd`或分别启动前后端服务

---

## 原始文档

一个基于Vue.js和Node.js的幼儿园照片管理系统，具有人脸识别、照片分类、权限管理等功能。

## 功能特性

### 核心功能
- **用户认证系统**：教师和家长分别登录
- **照片上传管理**：教师上传班级照片
- **人脸识别**：自动识别照片中的儿童
- **照片墙展示**：公共照片墙和私人照片查看
- **权限控制**：基于角色的访问控制

### 技术栈
- **前端**：Vue.js 3 + Element Plus + Pinia
- **后端**：Node.js + Express + MySQL
- **身份验证**：JWT
- **文件处理**：Multer
- **数据库**：MySQL 8.0

## 快速开始

### 环境要求
- Node.js 16+
- MySQL 8.0+
- 现代浏览器

### 安装步骤

1. 克隆项目
```bash
git clone <repository-url>
cd kindergarten_pg
```

2. 安装依赖
```bash
# 后端依赖
cd backend
npm install

# 前端依赖
cd ../frontend
npm install
```

3. 数据库配置
```bash
# 复制环境变量模板
cp backend/config/env.template backend/.env

# 编辑.env文件，配置数据库连接
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_NAME=kindergarten_system
```

4. 初始化数据库
```bash
cd backend
node init_db.js
```

5. 启动应用
```bash
# 方式1：使用启动脚本
./start.cmd

# 方式2：分别启动
cd backend && npm start
cd frontend && npm run serve
```

### 访问地址
- 前端：http://localhost:8080
- 后端API：http://localhost:3000

### 测试账号
- 教师账号：teacher1 / 123456
- 家长账号：parent1 / 123456

## 项目结构

```
kindergarten_pg/
├── backend/              # 后端代码
│   ├── config/          # 配置文件
│   ├── middleware/      # 中间件
│   ├── routes/          # API路由
│   ├── uploads/         # 上传文件目录
│   └── server.js        # 服务器入口
├── frontend/            # 前端代码
│   ├── src/
│   │   ├── components/  # 组件
│   │   ├── views/       # 页面
│   │   ├── router/      # 路由
│   │   └── store/       # 状态管理
│   └── public/          # 静态资源
├── database/            # 数据库相关
│   ├── schema.sql       # 数据库结构
│   └── init_data.sql    # 初始数据
└── README.md
```

## API文档

### 认证接口
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/logout` - 用户登出

### 照片接口
- `GET /api/photos/public` - 获取公共照片（包含activity活动场景信息）
- `GET /api/photos/private` - 获取私人照片（使用关联表精确查询，包含activity活动场景信息）
- `POST /api/photos` - 上传照片（支持activity参数用于标记活动场景）
- `POST /api/photos/like` - 点赞照片

### 用户管理
- `GET /api/users/profile` - 获取用户信息
- `PUT /api/users/profile` - 更新用户信息

### 班级管理
- `GET /api/classes` - 获取班级列表
- `POST /api/classes` - 创建班级
- `PUT /api/classes/:id` - 更新班级
- `DELETE /api/classes/:id` - 删除班级

## 功能说明

### 用户角色
1. **教师**：
   - 上传班级照片
   - 选择照片活动场景
   - 管理班级信息
   - 查看所有照片
   - 用户管理

2. **家长**：
   - 查看公共照片墙
   - 查看自己孩子的照片
   - 查看照片的活动场景信息
   - 点赞和评论
   - 下载照片

### 照片活动场景
- 支持14种预设活动场景分类
- 教师上传照片时可选择对应场景
- 家长端可以查看照片的活动场景信息
- 便于照片的分类管理和检索
- 场景包括：户外活动、室内游戏、美术手工、音乐舞蹈、体育运动、科学实验、阅读时间、午餐时间、午休时间、集体活动、自由活动、节日庆祝、生日聚会、其他

### 人脸识别
- 使用模拟人脸识别算法
- 自动标记照片中的儿童
- 生成识别置信度
- 支持多人识别
- 自动建立照片与儿童的关联关系（photo_child表）

### 权限控制
- JWT Token认证
- 基于角色的访问控制
- 路由守卫保护
- API接口权限验证
- 家长端通过关联表精确控制照片访问权限

### 家长-孩子关联管理
- 家长自助绑定孩子功能
- 通过学号进行绑定验证
- 支持多孩子绑定
- 灵活的解绑功能
- 实时绑定状态显示

## 部署说明

### 开发环境
```bash
# 后端
cd backend
npm run dev

# 前端
cd frontend
npm run serve
```

### 生产环境
```bash
# 前端构建
cd frontend
npm run build

# 后端启动
cd backend
npm start
```

## 贡献指南

1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 支持

如果您遇到问题或有建议，请：
1. 查看 [Issues](../../issues)
2. 创建新的 Issue
3. 联系项目维护者

---

**版本**: 1.0.0  
**最后更新**: 2025年7月9日 

### 最新修复日志

#### 2025-01-09 - 班级管理功能增强：学生学号管理

**功能增强：**
- 在教师端班级管理中添加学生学号字段
- 支持学号的增删改查操作
- 实现学号唯一性验证
- 提升学生信息管理的完整性

**变更内容：**
1. **前端界面优化**：
   - 学生列表表格添加学号列显示
   - 添加/编辑学生对话框增加学号输入框
   - 添加学号必填验证和长度验证
   - 优化表单布局：姓名 → 学号 → 班级

2. **后端API增强**：
   - 所有学生相关API支持学号字段
   - 添加学号唯一性检查，防止重复学号
   - 修改数据库查询，返回学号信息
   - 增强错误提示信息

3. **数据验证规则**：
   - 前端：学号必填，长度1-20字符
   - 后端：学号唯一性检查（全局和更新时排除当前记录）
   - 完整的数据校验流程

**功能特点：**
- 学号全局唯一性：系统内不允许重复学号
- 智能验证：编辑时排除当前学生，避免误报
- 数据完整性：姓名、学号、班级三要素缺一不可
- 用户友好：清晰的错误提示和验证规则

**使用说明：**
1. 教师进入班级管理页面
2. 点击"添加学生"输入姓名、学号、选择班级
3. 系统验证学号唯一性，通过后保存
4. 学生列表显示完整的学生信息包括学号
5. 编辑学生时可修改学号（需保证唯一性）

**技术实现：**
- 前端表单验证确保数据格式正确
- 后端多重检查保证数据完整性和唯一性
- 数据库层面支持学号字段存储和查询
- API响应包含完整的学生信息

#### 2025-01-09 - 注册功能优化：添加电话号码字段

**功能增强：**
- 在用户注册功能中添加电话号码字段
- 支持手机号码格式验证
- 防止重复电话号码注册
- 提升用户管理和联系便利性

**变更内容：**
1. **前端界面优化**：
   - 注册页面新增电话号码输入框
   - 添加手机号码格式验证（中国大陆手机号）
   - 优化字段排列顺序：用户名 → 密码 → 确认密码 → 姓名 → 电话号码 → 角色
   - 使用Phone图标提升视觉效果

2. **后端API增强**：
   - 注册接口支持telephone_number字段
   - 添加手机号码格式验证（使用validator库）
   - 检查电话号码唯一性，防止重复注册
   - 数据库存储电话号码信息

3. **数据验证规则**：
   - 前端：使用正则表达式验证中国大陆手机号格式
   - 后端：使用validator库的isMobilePhone验证
   - 必填字段验证，确保数据完整性

**使用说明：**
1. 访问注册页面，填写完整的用户信息
2. 电话号码需要输入11位中国大陆手机号
3. 系统会验证电话号码格式和唯一性
4. 注册成功后，电话号码将存储在用户档案中

**技术特点：**
- 前后端双重验证确保数据质量
- 唯一性检查防止重复注册
- 国际化电话号码验证支持
- 完整的错误提示机制

#### 2025-01-09 - 家长绑定功能优化：学号绑定

**功能优化：**
- 将家长绑定功能从使用学生ID改为使用学号(student_number)
- 提升了用户体验，学号比数字ID更直观易记
- 支持更灵活的学号格式，不限于纯数字

**变更内容：**
1. **后端API优化**：
   - 修改绑定API查询逻辑，使用 `student_number` 字段查找学生
   - 更新错误提示信息，从"学生ID有误"改为"学号有误"
   - 优化日志记录，包含学号信息便于调试

2. **前端界面优化**：
   - 表单字段从"学生ID"改为"学号"
   - 更新输入框占位符和验证规则
   - 已绑定孩子列表显示学号而非ID
   - 优化绑定说明文档，指导用户正确输入学号

3. **数据验证优化**：
   - 移除了纯数字验证限制，支持字母数字混合学号
   - 增加学号长度验证（1-20字符）
   - 保持重复绑定检查功能

**使用方法：**
1. 家长登录后点击"绑定孩子"
2. 输入孩子的学号（由教师提供）
3. 系统通过学号查找对应学生并建立绑定关系
4. 绑定成功后可查看孩子的专属照片

**技术实现：**
- 数据库查询：`SELECT * FROM children WHERE student_number = ?`
- 支持任意格式的学号：纯数字、字母数字混合等
- 保持原有的安全性和权限控制机制

#### 2025-01-09 - 家长-孩子关联管理功能重构

**功能变更：**
- 将家长-孩子关联管理功能从教师端移至家长端
- 家长现在可以自助绑定和管理孩子关联关系
- 提升了用户体验，减少了教师管理负担

**变更内容：**
1. **教师端功能移除**：
   - 移除了教师端用户管理页面的"管理关联"功能
   - 删除了相关的后端API路由（`POST /users/parent-child`、`DELETE /users/parent-child`、`PUT /users/:id/children`）
   - 简化了教师端用户管理界面

2. **家长端功能添加**：
   - 新增家长端孩子绑定页面（`/parent/binding`）
   - 家长可以通过输入学生ID自助绑定孩子
   - 支持查看已绑定的孩子列表
   - 支持解绑不需要的关联关系

3. **新增API端点**：
   - `POST /api/users/bind-child` - 家长绑定孩子
   - `DELETE /api/users/bind-child` - 家长解绑孩子
   - 权限控制：只有家长可以使用绑定功能

4. **用户界面优化**：
   - 家长端导航菜单增加"绑定孩子"选项
   - 提供详细的绑定说明和操作指南
   - 友好的错误提示和成功反馈

**使用方法：**
1. 家长登录后点击侧边栏的"绑定孩子"
2. 输入孩子的学号（由教师提供）
3. 点击"绑定孩子"按钮完成绑定
4. 绑定成功后可以查看孩子的专属照片

**技术特点：**
- 数据验证：确保学号存在且有效
- 重复绑定检查：避免重复绑定同一个孩子
- 权限控制：只有家长可以管理自己的绑定关系
- 错误处理：提供清晰的错误提示信息

**API端点：**
- `POST /api/users/bind-child` - 绑定孩子，请求体：`{ "studentNumber": string }`
- `DELETE /api/users/bind-child` - 解绑孩子，请求体：`{ "childId": number }` 